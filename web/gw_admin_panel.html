<?php
session_start();
if( $_SESSION['auth'] != 1 )
{
  header( "Location: gw_login.html?return=".$_SERVER['PHP_SELF'] );
  exit();
}
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
	<head>
		<title></title>
		<link href="/style/default.css" rel="stylesheet" type="text/css" />
		<style type= "text/css">
			html,body { border:0; margin:0; height:100%  }
			.gw_frame { width:1000px; min-height:400px; border: solid 1px #888; margin:50px auto; padding:0.5em; }
		</style>
		<!-- <noscript> not technically allowed in head but <script> is so ... ~ 'probably an oversight' -->
		<noscript>
			<meta http-equiv="Refresh" content="0;URL=/components/no-script.html" />
		</noscript>
	  <script type="text/javascript" src="/js/jquery.js"></script>
	  <script type="text/javascript" src="/js/common.js"></script>
	  <script type="text/javascript" src="gw-evt.js"></script>
		<script type="text/javascript">
		<!--
		  
		  jQuery(document).ready(function()
		  {
		    jQuery(document).bind("ips_cb", ips_cb );
		    jQuery(document).bind("stats_cb", stats_cb );
		    jQuery(document).bind("end_cb", end_cb );
		    ips();
		    setInterval( ips_update, 5000 );
		  });
		  
		  function ips_update()
		  {
		    jQuery("#session_list").children().remove();
		    ips();
		  }
		  
		  function ips_cb(e,result)
		  {
		    console.log( "ips_cb " );
		    console.log( result );
		    
		    if( result.status == "ok" )
		    {
		      var ips = result.ips;
		      for(var i = 0; i < ips.length; i++)
		      {
		        stats(ips[i]);
		      }
		    }
		  }
		  
		  function end_cb()
		  {
		    ips_update();
		  }

      /**
       * {status:"ok", stats:{IP:"12.12.12.28", MAC:"", state:3, time:0, quota:500, bandwidth:1000, timeRemaining:0, quotaRemaining:500, activityTimeRemaining:60, updateTimeRemaining:0, pauseTimeRemaining:30, endTimeRemaining:5, sessionTime:30}, ip:"12.12.12.28"}
       */
      function stats_cb(e,result)
      { 
        console.log( "stats_cb " );
        console.log( result );
        var str;
        var IP = result.stats.IP;
        var MAC = result.stats.MAC;        
        var state = parseInt(result.stats.state); //state_code_to_string(result.stats.state);
        var time = parseInt(result.stats.time);
        var timeRemaining = parseInt(result.stats.timeRemaining);
        var sessionTime = parseInt(result.stats.sessionTime);
        var quota = parseInt(result.stats.quota);
        var quotaRemaining = parseInt(result.stats.quotaRemaining);
        var bandwidth = parseInt(result.stats.bandwidth);
        var pauseTimeRemaining = parseInt(result.stats.pauseTimeRemaining);
        str  = "IP:" + IP + ",";
        str += "MAC:" + MAC + ",";
        str += "state:" + state + ",";
        str += "time:"  + timeRemaining  + "/" + time + ",";
        str += "quota:" + quotaRemaining + "/" + quota + ",";
        str += "<input type='button' value='end' class='end_button' />";        
        var item = jQuery( "<li>" + str + "</li>" );
        item.find(".end_button").click( function(){ end_session(IP); } );
	      jQuery("#session_list").append(item);
      }        
		  
		//-->
		</script>
	</head>
	<body>
	  <div class="gw_frame">
	    <h1>Admin Panel</h1>
	      <div>
          <ul id="session_list">
            <!-- session here -->
          </ul>
        </div>
        <div>
          <ul id="message_list">
            <!-- msg here -->
          </ul>              
          </div>
            <img id="ajax_strobe" src="" />
          </div>
        </div>
    </div>
	</body>
</html>
